version: 2.0
jobs:
  build:
    docker:
      - image: cimg/go:1.17
        auth:
          username: dorpolo
          password: $DOCKERHUB_PASSWORD  # context / project UI env-var reference
    steps:
      - checkout
      - attach_workspace:
          at: .
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Image Build & Push
          command: |
            HEROKU_APP_NAME=world-cup-22
            HEROKU_DST=registry.heroku.com/${HEROKU_APP_NAME}/web

            docker build -f Dockerfile \
              -t $HEROKU_DST . \
              --build-arg PG_PASS=$PG_PASS
            echo "image built successfully"
#            docker push $HEROKU_DST
#            echo docker pushed successfully into $HEROKU_DST
#      - run:
#          name: Heroku release
#          command: |
#            HEROKU_API_KEY=${HEROKU_TOKEN}
#            sudo sh release.sh $HEROKU_API_KEY
      - run:
          name: Setup Heroku
          command: |
            chmod +x setup-heroku.sh
            sh setup-heroku.sh $HEROKU_TOKEN
      - run:
          name: Login into Heroku Docker Repository
          command: |
            docker login --username=dorpolo --password=$HEROKU_TOKEN registry.heroku.com
      - run:
          name: Deploy Heroku Docker Container
          command: |
            heroku container:push web -a world-cup-22
            heroku container:release -a world-cup-22 web
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build:
          context: world-cup-2022
